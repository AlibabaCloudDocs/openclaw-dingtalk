{
  "meta": {
    "titleZh": "DingTalk 插件白盒沙盘",
    "subtitle": "openclaw-dingtalk control-flow + data-flow",
    "version": "2026-02-07",
    "repo": "openclaw-dingtalk",
    "channelId": "clawdbot-dingtalk",
    "npmPackage": "clawdbot-dingtalk"
  },
  "lanes": [
    { "id": "dingtalk", "labelZh": "DingTalk 平台", "x": 0, "y": 0, "w": 380, "h": 1000 },
    {
      "id": "plugin",
      "labelZh": "DingTalk 插件 (clawdbot-dingtalk)",
      "x": 380,
      "y": 0,
      "w": 520,
      "h": 1000
    },
    { "id": "openclaw", "labelZh": "Openclaw 核心", "x": 900, "y": 0, "w": 380, "h": 1000 },
    {
      "id": "mcp",
      "labelZh": "Aliyun MCP (DashScope / Bailian)",
      "x": 1280,
      "y": 0,
      "w": 320,
      "h": 1000
    }
  ],
  "nodes": [
    {
      "id": "dt_stream_callback",
      "labelZh": "Stream 回调 (WebSocket)",
      "kind": "external",
      "lane": "dingtalk",
      "x": 190,
      "y": 150,
      "w": 250,
      "h": 78,
      "summary": "DingTalk Stream 推送事件到机器人；SDK 触发 callback listener。"
    },
    {
      "id": "dt_session_webhook",
      "labelZh": "sessionWebhook (HTTP)",
      "kind": "external",
      "lane": "dingtalk",
      "x": 190,
      "y": 520,
      "w": 250,
      "h": 78,
      "summary": "每条入站消息携带的会话级 webhook。插件用它回发 text/markdown/image/file。"
    },
    {
      "id": "dt_openapi",
      "labelZh": "DingTalk OpenAPI",
      "kind": "external",
      "lane": "dingtalk",
      "x": 190,
      "y": 820,
      "w": 250,
      "h": 78,
      "summary": "需要 access_token 的主动调用：上传媒体、发送文件、AI Card 接口等。"
    },

    {
      "id": "plugin_register",
      "labelZh": "插件入口 register()",
      "kind": "function",
      "lane": "plugin",
      "x": 760,
      "y": 120,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/index.ts",
      "symbol": "default export plugin.register",
      "summary": "Openclaw 加载插件后调用：set runtime、registerChannel、registerTool(MCP)。",
      "codeRef": {
        "path": "extensions/dingtalk/index.ts",
        "hintRg": "rg -n \"register\\(api: OpenClawPluginApi\\)\" extensions/dingtalk/index.ts",
        "hintSed": "sed -n '1,120p' extensions/dingtalk/index.ts"
      }
    },
    {
      "id": "plugin_mcp_registrations",
      "labelZh": "MCP 工具注册表",
      "kind": "module",
      "lane": "plugin",
      "x": 760,
      "y": 210,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/mcp/tools.ts",
      "symbol": "createAliyunMcpRegistrations",
      "summary": "按配置启用/禁用百炼 MCP；注册 webSearch / codeInterpreter / webParser / wan26Media 四个工具工厂。",
      "codeRef": {
        "path": "extensions/dingtalk/src/mcp/tools.ts",
        "hintRg": "rg -n \"createAliyunMcpRegistrations|ALIYUN_MCP_PLUGIN_TOOL_NAMES\" extensions/dingtalk/src/mcp/tools.ts",
        "hintSed": "sed -n '1,120p' extensions/dingtalk/src/mcp/tools.ts"
      }
    },
    {
      "id": "plugin_channel_plugin",
      "labelZh": "ChannelPlugin 定义",
      "kind": "module",
      "lane": "plugin",
      "x": 760,
      "y": 315,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/channel.ts",
      "symbol": "export const dingtalkPlugin",
      "summary": "描述渠道能力、配置 schema、outbound 发送、gateway.startAccount 等。",
      "codeRef": {
        "path": "extensions/dingtalk/src/channel.ts",
        "hintRg": "rg -n \"export const dingtalkPlugin\" extensions/dingtalk/src/channel.ts",
        "hintSed": "sed -n '1,120p' extensions/dingtalk/src/channel.ts"
      }
    },
    {
      "id": "plugin_gateway_start",
      "labelZh": "gateway.startAccount()",
      "kind": "function",
      "lane": "plugin",
      "x": 760,
      "y": 415,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/channel.ts",
      "symbol": "dingtalkPlugin.gateway.startAccount",
      "summary": "Openclaw 启动渠道时调用：最终进入 monitorDingTalkProvider() 建立 Stream 连接。",
      "codeRef": {
        "path": "extensions/dingtalk/src/channel.ts",
        "hintRg": "rg -n \"gateway:\\s*\\{\\s*$|startAccount:\\s*async\" extensions/dingtalk/src/channel.ts",
        "hintSed": "rg -n \"startAccount\" extensions/dingtalk/src/channel.ts"
      }
    },
    {
      "id": "plugin_runtime",
      "labelZh": "runtime + 缓存",
      "kind": "state",
      "lane": "plugin",
      "x": 760,
      "y": 500,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/runtime.ts",
      "symbol": "setDingTalkRuntime / getOrCreateTokenManager / cardStreamCache",
      "summary": "保存 Openclaw runtime 引用；缓存 tokenManager 与 AI Card streaming state。",
      "codeRef": {
        "path": "extensions/dingtalk/src/runtime.ts",
        "hintRg": "rg -n \"setDingTalkRuntime|getOrCreateTokenManager|tokenManagerCache|cardStreamCache\" extensions/dingtalk/src/runtime.ts",
        "hintSed": "sed -n '1,220p' extensions/dingtalk/src/runtime.ts"
      }
    },
    {
      "id": "plugin_monitor",
      "labelZh": "monitorDingTalkProvider()",
      "kind": "module",
      "lane": "plugin",
      "x": 760,
      "y": 600,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/monitor.ts",
      "symbol": "monitorDingTalkProvider / handleInboundMessage / deliver(...)",
      "summary": "入站主循环：过滤消息 -> 构造 ctx -> dispatch 到 Openclaw -> deliver 回钉钉（含 AI Card/媒体/降级）。",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"export async function monitorDingTalkProvider|function handleInboundMessage\\(\" extensions/dingtalk/src/monitor.ts",
        "hintSed": "sed -n '220,520p' extensions/dingtalk/src/monitor.ts"
      }
    },

    {
      "id": "plugin_stream_client",
      "labelZh": "Stream Client",
      "kind": "module",
      "lane": "plugin",
      "x": 520,
      "y": 200,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/stream/client.ts",
      "symbol": "startDingTalkStreamClient",
      "summary": "封装 dingtalk-stream SDK：注册 TOPIC_ROBOT/TOPIC_CARD 回调，ACK 并异步转交 handler。",
      "codeRef": {
        "path": "extensions/dingtalk/src/stream/client.ts",
        "hintRg": "rg -n \"export async function startDingTalkStreamClient|registerCallbackListener\\(\" extensions/dingtalk/src/stream/client.ts",
        "hintSed": "sed -n '1,220p' extensions/dingtalk/src/stream/client.ts"
      }
    },
    {
      "id": "plugin_message_parser",
      "labelZh": "消息解析 + sessionKey",
      "kind": "module",
      "lane": "plugin",
      "x": 520,
      "y": 350,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/stream/message-parser.ts",
      "symbol": "extractChatbotMessage / buildSessionKey",
      "summary": "从不稳定的回调 schema 抽取 ChatbotMessage，并构造 SessionKey（DM vs group vs per-user）。",
      "codeRef": {
        "path": "extensions/dingtalk/src/stream/message-parser.ts",
        "hintRg": "rg -n \"export function extractChatbotMessage|export function buildSessionKey\" extensions/dingtalk/src/stream/message-parser.ts",
        "hintSed": "sed -n '1,260p' extensions/dingtalk/src/stream/message-parser.ts"
      }
    },
    {
      "id": "plugin_deliver",
      "labelZh": "deliver(payload, kind)",
      "kind": "function",
      "lane": "plugin",
      "x": 520,
      "y": 710,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/monitor.ts",
      "symbol": "dispatcherOptions.deliver",
      "summary": "Openclaw 产出的 reply payload 在这里落地：AI Card/媒体协议/markdown 转换/sessionWebhook 发送。",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"const dispatcherOptions = \\{\\s*deliver: async\" extensions/dingtalk/src/monitor.ts",
        "hintSed": "rg -n \"deliver: async\" extensions/dingtalk/src/monitor.ts"
      }
    },
    {
      "id": "plugin_send_reply",
      "labelZh": "sessionWebhook Reply",
      "kind": "module",
      "lane": "plugin",
      "x": 520,
      "y": 860,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/send/reply.ts",
      "symbol": "sendReplyViaSessionWebhook / sendImageViaSessionWebhook",
      "summary": "把 text/markdown/image/file POST 到 sessionWebhook；长文自动分段；markdown 表格转 code block。",
      "codeRef": {
        "path": "extensions/dingtalk/src/send/reply.ts",
        "hintRg": "rg -n \"sendReplyViaSessionWebhook|sendImageWithMediaIdViaSessionWebhook\" extensions/dingtalk/src/send/reply.ts",
        "hintSed": "sed -n '1,220p' extensions/dingtalk/src/send/reply.ts"
      }
    },
    {
      "id": "plugin_media_protocol",
      "labelZh": "媒体协议 [DING:*]",
      "kind": "module",
      "lane": "plugin",
      "x": 760,
      "y": 710,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/media-protocol.ts",
      "symbol": "parseMediaProtocol / replaceMediaTags",
      "summary": "解析并替换 AI 输出中的 [DING:IMAGE/FILE/VIDEO/AUDIO] 标签；上传后嵌入/或单独发送。",
      "codeRef": {
        "path": "extensions/dingtalk/src/media-protocol.ts",
        "hintRg": "rg -n \"export function parseMediaProtocol|export async function replaceMediaTags\" extensions/dingtalk/src/media-protocol.ts",
        "hintSed": "sed -n '1,220p' extensions/dingtalk/src/media-protocol.ts"
      }
    },
    {
      "id": "plugin_ai_card",
      "labelZh": "AI Card 状态机",
      "kind": "module",
      "lane": "plugin",
      "x": 760,
      "y": 860,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/monitor.ts",
      "symbol": "maybeHandleAICardDelivery",
      "summary": "当开启 aiCard 时，将 reply payload 映射为卡片 create/deliver/stream/update；支持节流与 final 合成。",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"async function maybeHandleAICardDelivery\" extensions/dingtalk/src/monitor.ts",
        "hintSed": "rg -n \"maybeHandleAICardDelivery\" extensions/dingtalk/src/monitor.ts"
      }
    },

    {
      "id": "oc_plugin_loader",
      "labelZh": "Plugin Loader",
      "kind": "module",
      "lane": "openclaw",
      "x": 1090,
      "y": 120,
      "w": 250,
      "h": 78,
      "file": "openclaw/src/plugins/loader.ts",
      "symbol": "load plugins + call register(api)",
      "summary": "加载 extensions 并调用插件的 register(api)/activate(api)。",
      "codeRef": {
        "path": "openclaw/src/plugins/loader.ts",
        "hintRg": "rg -n \"const result = register\\(api\\)\" openclaw/src/plugins/loader.ts",
        "hintSed": "sed -n '380,460p' openclaw/src/plugins/loader.ts"
      }
    },
    {
      "id": "oc_plugin_api",
      "labelZh": "OpenClawPluginApi",
      "kind": "api",
      "lane": "openclaw",
      "x": 1090,
      "y": 230,
      "w": 250,
      "h": 78,
      "file": "openclaw/src/plugins/types.ts",
      "symbol": "OpenClawPluginApi",
      "summary": "插件可调用的 API：registerChannel/registerTool/runtime/config/pluginConfig/logger 等。",
      "codeRef": {
        "path": "openclaw/src/plugins/types.ts",
        "hintRg": "rg -n \"export type OpenClawPluginApi\" openclaw/src/plugins/types.ts",
        "hintSed": "sed -n '220,320p' openclaw/src/plugins/types.ts"
      }
    },
    {
      "id": "oc_gateway",
      "labelZh": "Gateway 启停",
      "kind": "module",
      "lane": "openclaw",
      "x": 1090,
      "y": 350,
      "w": 250,
      "h": 78,
      "file": "openclaw/src/gateway/server-channels.ts",
      "symbol": "startAccount(...)",
      "summary": "根据配置启动渠道账号：调用 ChannelPlugin.gateway.startAccount 并管理 Abort/运行状态。",
      "codeRef": {
        "path": "openclaw/src/gateway/server-channels.ts",
        "hintRg": "rg -n \"const task = startAccount\\(\" openclaw/src/gateway/server-channels.ts",
        "hintSed": "sed -n '120,220p' openclaw/src/gateway/server-channels.ts"
      }
    },
    {
      "id": "oc_dispatcher",
      "labelZh": "Reply Dispatcher",
      "kind": "module",
      "lane": "openclaw",
      "x": 1090,
      "y": 520,
      "w": 250,
      "h": 78,
      "file": "openclaw/src/auto-reply/reply/provider-dispatcher.ts",
      "symbol": "dispatchReplyWithBufferedBlockDispatcher",
      "summary": "渠道把 ctx 交给 Openclaw 的 auto-reply 管线；它会处理 reply 路由/缓冲 block/final，再回调 deliver()。",
      "codeRef": {
        "path": "openclaw/src/auto-reply/reply/provider-dispatcher.ts",
        "hintRg": "rg -n \"dispatchReplyWithBufferedBlockDispatcher\" openclaw/src/auto-reply/reply/provider-dispatcher.ts",
        "hintSed": "sed -n '1,120p' openclaw/src/auto-reply/reply/provider-dispatcher.ts"
      }
    },
    {
      "id": "oc_agent_pipeline",
      "labelZh": "Agent 管线",
      "kind": "module",
      "lane": "openclaw",
      "x": 1090,
      "y": 700,
      "w": 250,
      "h": 78,
      "file": "openclaw/src/auto-reply/reply/dispatch-from-config.ts",
      "symbol": "dispatchReplyFromConfig",
      "summary": "解析会话与配置，执行 agent/模型、工具调用、去重与路由，再把 payload 送回 dispatcher。",
      "codeRef": {
        "path": "openclaw/src/auto-reply/reply/dispatch-from-config.ts",
        "hintRg": "rg -n \"export async function dispatchReplyFromConfig\" openclaw/src/auto-reply/reply/dispatch-from-config.ts",
        "hintSed": "sed -n '60,140p' openclaw/src/auto-reply/reply/dispatch-from-config.ts"
      }
    },
    {
      "id": "oc_tools",
      "labelZh": "Tools / MCP",
      "kind": "module",
      "lane": "openclaw",
      "x": 1090,
      "y": 860,
      "w": 250,
      "h": 78,
      "file": "openclaw/src/plugins/runtime/index.ts",
      "symbol": "runtime.tools + tool invoke",
      "summary": "工具注册/可选工具与调用结果回传（插件通过 api.registerTool 注册到这里）。",
      "codeRef": {
        "path": "openclaw/src/plugins/runtime/index.ts",
        "hintRg": "rg -n \"registerTool\\(|tools\" openclaw/src/plugins/runtime/index.ts",
        "hintSed": "sed -n '160,240p' openclaw/src/plugins/runtime/index.ts"
      }
    },

    {
      "id": "mcp_client",
      "labelZh": "invokeAliyunMcpTool()",
      "kind": "module",
      "lane": "mcp",
      "x": 1440,
      "y": 200,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/mcp/client.ts",
      "symbol": "invokeAliyunMcpTool",
      "summary": "通过 DashScope MCP SSE endpoint 调用远端工具；处理超时/错误与返回结构。",
      "codeRef": {
        "path": "extensions/dingtalk/src/mcp/client.ts",
        "hintRg": "rg -n \"export async function invokeAliyunMcpTool\" extensions/dingtalk/src/mcp/client.ts",
        "hintSed": "sed -n '1,120p' extensions/dingtalk/src/mcp/client.ts"
      }
    },
    {
      "id": "mcp_web_search",
      "labelZh": "MCP: WebSearch",
      "kind": "tool",
      "lane": "mcp",
      "x": 1440,
      "y": 360,
      "w": 260,
      "h": 78,
      "summary": "联网搜索（百炼 MCP）。不可用时按“availability-first”降级。",
      "tags": ["aliyun-mcp", "web"]
    },
    {
      "id": "mcp_code_interpreter",
      "labelZh": "MCP: Code Interpreter",
      "kind": "tool",
      "lane": "mcp",
      "x": 1440,
      "y": 520,
      "w": 260,
      "h": 78,
      "summary": "远程代码解释器（百炼 MCP）。",
      "tags": ["aliyun-mcp"]
    },
    {
      "id": "mcp_web_parser",
      "labelZh": "MCP: WebParser",
      "kind": "tool",
      "lane": "mcp",
      "x": 1440,
      "y": 680,
      "w": 260,
      "h": 78,
      "summary": "网页抽取/解析（百炼 MCP）。",
      "tags": ["aliyun-mcp", "web"]
    },
    {
      "id": "mcp_wan26",
      "labelZh": "MCP: Wan2.6 Media",
      "kind": "tool",
      "lane": "mcp",
      "x": 1440,
      "y": 840,
      "w": 260,
      "h": 78,
      "file": "extensions/dingtalk/src/mcp/wan26-auto-reply.ts",
      "symbol": "autoSendWan26MediaToDingtalk",
      "summary": "通义万相2.6 生成图/视频；可选择自动回传到当前 DingTalk session。",
      "codeRef": {
        "path": "extensions/dingtalk/src/mcp/wan26-auto-reply.ts",
        "hintRg": "rg -n \"autoSendWan26MediaToDingtalk\" extensions/dingtalk/src/mcp/wan26-auto-reply.ts",
        "hintSed": "sed -n '1,220p' extensions/dingtalk/src/mcp/wan26-auto-reply.ts"
      },
      "tags": ["aliyun-mcp", "media"]
    }
  ],
  "edges": [
    {
      "id": "e_loader_register",
      "from": "oc_plugin_loader",
      "to": "plugin_register",
      "flowType": "control",
      "labelZh": "call register(api)",
      "codeRef": {
        "path": "openclaw/src/plugins/loader.ts",
        "hintRg": "rg -n \"const result = register\\(api\\)\" openclaw/src/plugins/loader.ts"
      }
    },
    {
      "id": "e_register_runtime",
      "from": "plugin_register",
      "to": "plugin_runtime",
      "flowType": "data",
      "labelZh": "setDingTalkRuntime(api.runtime)",
      "codeRef": {
        "path": "extensions/dingtalk/index.ts",
        "hintRg": "rg -n \"setDingTalkRuntime\" extensions/dingtalk/index.ts"
      }
    },
    {
      "id": "e_register_channel",
      "from": "plugin_register",
      "to": "oc_plugin_api",
      "flowType": "control",
      "labelZh": "api.registerChannel(dingtalkPlugin)",
      "codeRef": {
        "path": "extensions/dingtalk/index.ts",
        "hintRg": "rg -n \"registerChannel\\(\\{ plugin: dingtalkPlugin \\}\\)\" extensions/dingtalk/index.ts"
      }
    },
    {
      "id": "e_register_mcp_build",
      "from": "plugin_register",
      "to": "plugin_mcp_registrations",
      "flowType": "control",
      "labelZh": "createAliyunMcpRegistrations(...)",
      "codeRef": {
        "path": "extensions/dingtalk/index.ts",
        "hintRg": "rg -n \"createAliyunMcpRegistrations\" extensions/dingtalk/index.ts"
      }
    },
    {
      "id": "e_register_mcp_tools",
      "from": "plugin_mcp_registrations",
      "to": "oc_plugin_api",
      "flowType": "control",
      "labelZh": "api.registerTool(factory)",
      "codeRef": {
        "path": "extensions/dingtalk/index.ts",
        "hintRg": "rg -n \"api\\.registerTool\" extensions/dingtalk/index.ts"
      }
    },

    {
      "id": "e_gateway_start_account",
      "from": "oc_gateway",
      "to": "plugin_gateway_start",
      "flowType": "control",
      "labelZh": "startAccount(ctx)",
      "codeRef": {
        "path": "openclaw/src/gateway/server-channels.ts",
        "hintRg": "rg -n \"const task = startAccount\\(\" openclaw/src/gateway/server-channels.ts"
      }
    },
    {
      "id": "e_plugin_start_monitor",
      "from": "plugin_gateway_start",
      "to": "plugin_monitor",
      "flowType": "control",
      "labelZh": "monitorDingTalkProvider(...)",
      "codeRef": {
        "path": "extensions/dingtalk/src/channel.ts",
        "hintRg": "rg -n \"return monitorDingTalkProvider\\(\" extensions/dingtalk/src/channel.ts"
      }
    },
    {
      "id": "e_monitor_start_stream",
      "from": "plugin_monitor",
      "to": "plugin_stream_client",
      "flowType": "control",
      "labelZh": "startDingTalkStreamClient(...)",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"const client = await startDingTalkStreamClient\" extensions/dingtalk/src/monitor.ts"
      }
    },
    {
      "id": "e_stream_receive",
      "from": "dt_stream_callback",
      "to": "plugin_stream_client",
      "flowType": "control",
      "labelZh": "TOPIC_ROBOT / TOPIC_CARD callback",
      "codeRef": {
        "path": "extensions/dingtalk/src/stream/client.ts",
        "hintRg": "rg -n \"registerCallbackListener\\(TOPIC_ROBOT|TOPIC_CARD_INSTANCE_CALLBACK\" extensions/dingtalk/src/stream/client.ts"
      }
    },
    {
      "id": "e_stream_parse",
      "from": "plugin_stream_client",
      "to": "plugin_message_parser",
      "flowType": "data",
      "labelZh": "extractChatbotMessage(raw)",
      "codeRef": {
        "path": "extensions/dingtalk/src/stream/client.ts",
        "hintRg": "rg -n \"extractChatbotMessage\" extensions/dingtalk/src/stream/client.ts"
      }
    },
    {
      "id": "e_parse_to_monitor",
      "from": "plugin_message_parser",
      "to": "plugin_monitor",
      "flowType": "data",
      "labelZh": "ChatbotMessage",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"onChatMessage: async \\(chat\" extensions/dingtalk/src/monitor.ts"
      }
    },
    {
      "id": "e_monitor_build_sessionkey",
      "from": "plugin_monitor",
      "to": "plugin_message_parser",
      "flowType": "data",
      "labelZh": "buildSessionKey(chat, ...)",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"buildSessionKey\\(\" extensions/dingtalk/src/monitor.ts"
      }
    },

    {
      "id": "e_monitor_dispatch",
      "from": "plugin_monitor",
      "to": "oc_dispatcher",
      "flowType": "control",
      "labelZh": "dispatchReplyWithBufferedBlockDispatcher(ctx)",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"dispatchReplyWithBufferedBlockDispatcher\" extensions/dingtalk/src/monitor.ts"
      }
    },
    {
      "id": "e_dispatch_to_pipeline",
      "from": "oc_dispatcher",
      "to": "oc_agent_pipeline",
      "flowType": "control",
      "labelZh": "dispatchInboundMessageWithBufferedDispatcher",
      "codeRef": {
        "path": "openclaw/src/auto-reply/dispatch.ts",
        "hintRg": "rg -n \"dispatchInboundMessageWithBufferedDispatcher\" openclaw/src/auto-reply/dispatch.ts"
      }
    },
    {
      "id": "e_pipeline_deliver",
      "from": "oc_agent_pipeline",
      "to": "plugin_deliver",
      "flowType": "data",
      "labelZh": "deliver(payload, kind=block/final)",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"deliver called\" extensions/dingtalk/src/monitor.ts"
      }
    },

    {
      "id": "e_deliver_ai_card",
      "from": "plugin_deliver",
      "to": "plugin_ai_card",
      "flowType": "control",
      "labelZh": "maybeHandleAICardDelivery()",
      "condition": "payload.channelData.dingtalk.card 或 aiCard autoReply",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"maybeHandleAICardDelivery\\(\" extensions/dingtalk/src/monitor.ts"
      }
    },
    {
      "id": "e_ai_card_openapi",
      "from": "plugin_ai_card",
      "to": "dt_openapi",
      "flowType": "control",
      "labelZh": "card-instances create/deliver/stream/update",
      "codeRef": {
        "path": "extensions/dingtalk/src/api/card-instances.ts",
        "hintRg": "rg -n \"createCardInstance|deliverCardInstance|streamCardInstance|updateCardInstance\" extensions/dingtalk/src/api/card-instances.ts"
      }
    },

    {
      "id": "e_deliver_media_protocol",
      "from": "plugin_deliver",
      "to": "plugin_media_protocol",
      "flowType": "control",
      "labelZh": "parse/replace [DING:*] tags",
      "condition": "hasMediaTags(text)",
      "codeRef": {
        "path": "extensions/dingtalk/src/monitor.ts",
        "hintRg": "rg -n \"hasMediaTags\\(|replaceMediaTags\\(|processMediaItems\\(\" extensions/dingtalk/src/monitor.ts"
      }
    },
    {
      "id": "e_media_upload_openapi",
      "from": "plugin_media_protocol",
      "to": "dt_openapi",
      "flowType": "control",
      "labelZh": "uploadMedia / uploadMediaToOAPI",
      "codeRef": {
        "path": "extensions/dingtalk/src/send/media-sender.ts",
        "hintRg": "rg -n \"uploadMedia\\(|uploadMediaToOAPI\\(\" extensions/dingtalk/src/send/media-sender.ts"
      }
    },
    {
      "id": "e_media_send_webhook",
      "from": "plugin_media_protocol",
      "to": "dt_session_webhook",
      "flowType": "control",
      "labelZh": "sendImageWithMediaId / msgtype=file",
      "codeRef": {
        "path": "extensions/dingtalk/src/send/media-sender.ts",
        "hintRg": "rg -n \"sendImageWithMediaIdViaSessionWebhook|msgtype: \\\"file\\\"\" extensions/dingtalk/src/send/media-sender.ts"
      }
    },

    {
      "id": "e_deliver_reply",
      "from": "plugin_deliver",
      "to": "plugin_send_reply",
      "flowType": "control",
      "labelZh": "sendReplyViaSessionWebhook(...)",
      "condition": "allowText(kind=final 或 verbose 开启)",
      "codeRef": {
        "path": "extensions/dingtalk/src/send/reply.ts",
        "hintRg": "rg -n \"export async function sendReplyViaSessionWebhook\" extensions/dingtalk/src/send/reply.ts"
      }
    },
    {
      "id": "e_reply_to_webhook",
      "from": "plugin_send_reply",
      "to": "dt_session_webhook",
      "flowType": "control",
      "labelZh": "POST msgtype=text/markdown/image/file",
      "codeRef": {
        "path": "extensions/dingtalk/src/send/reply.ts",
        "hintRg": "rg -n \"fetch\\(sessionWebhook\" extensions/dingtalk/src/send/reply.ts"
      }
    },

    {
      "id": "e_tools_to_mcp",
      "from": "oc_tools",
      "to": "mcp_client",
      "flowType": "control",
      "labelZh": "invokeAliyunMcpTool(...)",
      "condition": "tool = aliyun MCP (webSearch/...)",
      "codeRef": {
        "path": "extensions/dingtalk/src/mcp/tools.ts",
        "hintRg": "rg -n \"invokeAliyunMcpTool\" extensions/dingtalk/src/mcp/tools.ts"
      }
    },
    {
      "id": "e_mcp_websearch",
      "from": "mcp_client",
      "to": "mcp_web_search",
      "flowType": "control",
      "labelZh": "SSE -> webSearch endpoint",
      "condition": "tools.webSearch.enabled"
    },
    {
      "id": "e_mcp_code_interpreter",
      "from": "mcp_client",
      "to": "mcp_code_interpreter",
      "flowType": "control",
      "labelZh": "SSE -> codeInterpreter endpoint",
      "condition": "tools.codeInterpreter.enabled"
    },
    {
      "id": "e_mcp_webparser",
      "from": "mcp_client",
      "to": "mcp_web_parser",
      "flowType": "control",
      "labelZh": "SSE -> webParser endpoint",
      "condition": "tools.webParser.enabled"
    },
    {
      "id": "e_mcp_wan26",
      "from": "mcp_client",
      "to": "mcp_wan26",
      "flowType": "control",
      "labelZh": "SSE -> Wan2.6 endpoint",
      "condition": "tools.wan26Media.enabled"
    },
    {
      "id": "e_wan26_auto_send",
      "from": "mcp_wan26",
      "to": "dt_openapi",
      "flowType": "control",
      "labelZh": "autoSendToDingtalk: sendMediaByPath",
      "condition": "wan26Media.autoSendToDingtalk && sessionKey 可解析 target",
      "codeRef": {
        "path": "extensions/dingtalk/src/mcp/wan26-auto-reply.ts",
        "hintRg": "rg -n \"autoSendWan26MediaToDingtalk\\(\" extensions/dingtalk/src/mcp/wan26-auto-reply.ts"
      }
    }
  ]
}

