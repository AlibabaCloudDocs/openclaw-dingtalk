#!/usr/bin/expect -f
# 测试交互式配置向导

set timeout 30

# 获取脚本路径
if {[llength $argv] > 0} {
    set script_path [lindex $argv 0]
} else {
    set script_path "./openclaw_installer.sh"
}

set dashscope_api_key "sk-test-key"
set dashscope_base_url "https://api.example.com/v1"

puts "=========================================="
puts "  配置向导交互测试"
puts "=========================================="
puts ""

# 启动配置向导
spawn bash $script_path --configure

# 1. 可能进入配置管理菜单
expect {
    -re "配置管理|Configuration.*Management" {
        puts "\n\[INFO\] 进入配置管理菜单，输入 5 选择全新配置向导"
        send "5"
        exp_continue
    }
    -re "覆盖|overwrite|已存在|exists" {
        puts "\n\[INFO\] 发现已有配置，输入 y 确认覆盖"
        send "y\r"
    }
    -re "Base URL|baseUrl|API 地址" {
        puts "\n\[INFO\] 直接进入配置流程"
        send "$dashscope_base_url\r"
    }
    timeout {
        puts "\n\[FAIL\] 等待初始界面超时"
        exit 1
    }
}

# 2. 如果之前是菜单，现在应该会有覆盖确认或直接进入 Base URL
expect {
    -re "覆盖|overwrite|已存在|exists" {
        send "y\r"
        exp_continue
    }
    -re "Base URL|baseUrl|API 地址" {
        send "$dashscope_base_url\r"
    }
    timeout {
        puts "\n\[FAIL\] 等待 Base URL 提示超时"
        exit 1
    }
}

# 3. 输入 API Key
expect {
    -re "API Key|apiKey|密钥" {
        send "$dashscope_api_key\r"
    }
    timeout {
        puts "\n\[FAIL\] 等待 API Key 提示超时"
        exit 1
    }
}

# 4. 选择模型
expect {
    -re "模型|model|Model|选择" {
        send "\r"
    }
    timeout {
        puts "\n\[FAIL\] 等待模型选择提示超时"
        exit 1
    }
}

# 5. 等待完成
expect {
    -re "完成|complete|success|成功|saved|保存|渠道管理" {
        puts "\n\[OK\] 配置向导完成"
    }
    timeout {
        puts "\n\[FAIL\] 等待完成消息超时"
        exit 1
    }
}

puts ""
puts "=========================================="
puts "  配置向导交互测试通过"
puts "=========================================="

exit 0
